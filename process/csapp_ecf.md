[toc]

# Exceptional Control Flow

从给处理器加电到断电为止，程序计数器 PC 中的值形成了一个 a~1~, a~2~, ..., a~n-1~ 的序列。其中 a~k~ 表示指令 I~k~ 的地址，从 a~k~ 到 a~k+1~ 的变化称为 **控制转移 (control transfer)** 。上边的序列称为处理器的 **控制流 (control flow)** 。

通过使用跳转、分支、调用和返回指令，程序可以根据由程序变量表示的内部程序状态的变化来改变控制流（表现为指令 I~k~ 和 I~k+1~ 在内存中不相邻），但是这种控制流的变化只局限于程序内部。

同时，系统也必须对系统状态的变化做出反应，比如数据从磁盘或网络适配器到达、指令除以零和系统计时器到时等。这类控制流的突变统称为 **异常控制流 (exceptional control flow, ECF)** 。ECF 机制发生在系统的各个层次：硬件层（硬件检测到的事件触发异常处理程序）、操作系统层（系统调用，进程上下文切换，信号）、应用层（C 语言中的 setjmp 和 longjmp 函数，C++ 和 Java 语言中的 try-catch 机制，Go 语言中的 panic 和 recover 函数，Python 语言的 try-except 机制）。

# 1. （硬件）异常

**异常(exception)** 是控制流的突变，用来响应处理器状态的某些变化。处理器的 **状态(state)** 在处理器中被编码为不同的位和信号，状态的变化也称为 **事件(event)** 。事件既可能和当前执行的指令有关（虚拟内存缺页，算术溢出，除以零），也可能无关（系统定时器产生的信号，I/O 请求完成）。

### 1.1 异常处理

异常处理的基本思想如下图所示。任何情况下处理器检测到有事件发生时，它通过 **异常表(exception table)** 执行间接过程调用，到一个专门处理此类事件的称为 **异常处理程序(exception handler)** 的操作系统子程序中处理异常，然后根据异常类型执行后续操作（1.2 节）。

![anatomy_of_exception](assets/anatomy_of_exception.png)

系统中每种可能的异常都被分配了一个唯一的称为 **异常号(exception number)** 的非负整数，它被用作异常表的索引。当系统启动时，操作系统会分配和初始化一张异常表，表的起始地址放在 **异常表基址寄存器(exception table base register)** 中，而表项 k 则存放异常 k 的处理程序的地址。当处理器检测到事件发生时，它首先生成异常处理程序的地址，然后转到相应的处理程序。

![exception_handling](assets/exception_handling.png)

所以，异常的处理是由硬件和软件合作完成的。硬件负责触发异常和生成异常处理程序的地址，剩下的工作由异常处理程序完成。

### 1.2 异常分类

异常分类概览：

![exception_classes](assets/exception_classes.png)

##### 1.2.1 中断

**中断(interrupt)** 是 **异步(asynchronously)** 发生的，异步的含义是中断不是由任何一条专门的指令的执行造成的。中断的异常号用于标识引发中断的设备，用于处理中断的异常处理程序称为 **中断处理程序(interrupt handler)** 。

![interrupt](assets/interrupt.png)

##### 1.2.2 陷阱

**陷阱(trap)** 是通过执行一条指令而引发的 **有意的(intentional)** 异常，它最重要的用途是 **系统调用(system call)** 。从程序员的角度来看，系统调用和普通的函数调用是一样的，但是系统调用运行在内核模式而普通函数调用运行在用户模式。

![trap](assets/trap.png)

##### 1.2.3 故障

**故障(fault)** 是执行一条指令时出现的错误情况，它有可能被故障处理程序修复，也可能会造成当前程序终止。

最典型的故障是 **缺页异常(page fault)** 。当指令引用的虚拟地址对应的物理页面不在内存中时会发生缺页异常，然后缺页处理程序会从磁盘中加载页面并将控制返回给当前指令重新执行。

![fault](assets/fault.png)

##### 1.2.4 终止

**终止(abort)** 是执行指令时发生的不可恢复的致命错误。异常处理程序会将控制交给 `abort` 例程，该例程会终止程序。

![abort](assets/abort.png)
